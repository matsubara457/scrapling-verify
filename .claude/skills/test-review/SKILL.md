---
name: test-review
description: テスト戦略設計・カバレッジ分析・テスト品質改善
argument-hint: "[相談内容(例: カバレッジ改善, テスト設計, フレーキーテスト)]"
disable-model-invocation: true
allowed-tools: Bash(pnpm *), Bash(npx *)
---

## 手順

### 1. 現状把握
`backend/src/__tests__/` の全テストを読む + `pnpm test -- --coverage` でカバレッジ測定

### 2. 相談内容別対応

#### カバレッジ分析・改善
- カバレッジレポートから未テスト箇所を特定
- 優先度付け: クリティカルパス > エッジケース > ユーティリティ
- 不足テストの自動生成（`/test` スキルと連携）

#### テスト戦略設計
- テストピラミッド: Unit(多) > Integration(中) > E2E(少)
- 各レイヤーのテスト方針:
  - Repository: DBモック or テストDB → CRUD操作検証
  - Service: Repository モック → ビジネスロジック検証
  - Route: app.request() → エンドポイント統合テスト
  - Validator: Zodスキーマの正常/異常系網羅
- モック戦略: vi.mock() の粒度とスコープ

#### テスト品質改善
- フレーキー（不安定）テストの検出と修正
- テスト間の依存関係排除（独立性確保）
- テストデータ設計: ファクトリパターン / Fixtures
- アサーションの精度向上（toEqual vs toMatchObject）
- テスト名の可読性改善（日本語「〜の場合、〜すること」）

#### パフォーマンステスト
- テスト実行時間の分析（遅いテストの特定）
- 並列実行の最適化
- モック最適化（不要なsetup/teardownの排除）

#### リグレッションテスト設計
- バグ修正後のリグレッションテスト自動追加
- 変更影響範囲の自動テスト選択

### 3. 報告
カバレッジ状況 + 改善提案 + 優先度付きテスト追加リスト

### 4. 実行
提案承認後、テストを自動生成・実行。`pnpm test` で全件パスを確認。
